#!/bin/bash

set -e -o pipefail

# Load .env file if it exists (for local development)
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs)
fi

case $1 in
  local)
    # Use API_DB from environment, or fall back to default
    dsn="${API_DB:-postgres://postgres:password@localhost:5432?sslmode=disable}"
    ;;

  dev-ucarion)
    dsn=$(AWS_REGION=us-east-2 AWS_PROFILE=dev-ucarion-admin aws secretsmanager get-secret-value --secret-id psql | jq -r .SecretString | jq -r .DATABASE_URL_WRITE)
    ;;

  stage)
    dsn=$(AWS_REGION=us-east-2 AWS_PROFILE=stage-admin aws secretsmanager get-secret-value --secret-id psql | jq -r .SecretString | jq -r .DATABASE_URL_WRITE)
    ;;

  prod)
    dsn=$(AWS_REGION=us-east-2 AWS_PROFILE=prod-admin aws secretsmanager get-secret-value --secret-id psql | jq -r .SecretString | jq -r .DATABASE_URL_WRITE)
    ;;

  *)
    echo "unknown environment: $1" 1>&2;
    exit 1
esac

# shellcheck disable=SC2068
go run ./cmd/migrate --database "$dsn" ${@:2}
